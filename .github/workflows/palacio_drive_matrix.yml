name: Palacio Scraper (Drive-only + Email CHANGES)

on:
  schedule:
    - cron: "0 8,20 * * *"   # 02:00 y 14:00 CDMX aprox.
  workflow_dispatch:
    inputs:
      run_all:
        description: "Ejecutar TODAS las categor√≠as"
        type: boolean
        default: true
        required: true
      category:
        description: "Categor√≠a √∫nica (si run_all = false). Ej: juguetes"
        type: string
        required: false
        default: ""
      start:
        description: "Offset inicial start="
        type: string
        required: false
        default: ""
      page_size:
        description: "Tama√±o de p√°gina sz="
        type: string
        required: false
        default: ""
      page_step:
        description: "Salto de start"
        type: string
        required: false
        default: ""
      max_pages:
        description: "M√°ximo de p√°ginas"
        type: string
        required: false
        default: ""
      highlight:
        description: "Umbral % para resaltar"
        type: string
        required: false
        default: "51"

permissions:
  contents: read

concurrency:
  group: palacio-scraper
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    env:
      OUT_TMP_DIR: /tmp/ph          # salida ef√≠mera
      DRIVE_DEST: mydrive:ph        # tu remoto rclone y carpeta en Drive

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
          python -m pip install -U pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install requests pandas beautifulsoup4 xlsxwriter openpyxl pyarrow
          fi

      - name: Prepare temp dir
        run: |
          rm -rf "$OUT_TMP_DIR"
          mkdir -p "$OUT_TMP_DIR"

      - name: Install rclone
        run: |
          curl -L -o rclone.zip https://downloads.rclone.org/rclone-current-linux-amd64.zip
          unzip -q rclone.zip
          sudo mv rclone-*-linux-amd64/rclone /usr/local/bin/rclone
          rclone version

      - name: Write rclone.conf from secret
        env:
          RCLONE_CONFIG: ${{ secrets.RCLONE_CONFIG }}
        run: |
          mkdir -p ~/.config/rclone
          (echo "$RCLONE_CONFIG" | base64 -d > ~/.config/rclone/rclone.conf) || \
          (echo "$RCLONE_CONFIG" > ~/.config/rclone/rclone.conf)
          echo "==== Remotos detectados ===="
          rclone listremotes || true
          # Validaci√≥n de 'mydrive:'
          if ! rclone listremotes | grep -q "^mydrive:" ; then
            echo "‚ùå Falta el remoto 'mydrive:' en tu RCLONE_CONFIG"
            exit 1
          fi

      - name: (Pull) Traer hist√≥rico desde Drive ‚Üí /tmp/ph
        run: |
          rclone mkdir "${DRIVE_DEST}" || true
          # Trae todo lo que haya (para comparar con el snapshot previo)
          rclone copy "${DRIVE_DEST}" "${OUT_TMP_DIR}" --create-empty-src-dirs -P || true

      - name: Run scraper (disco + diffs)
        env:
          OUT_BASE_DIR: ${{ env.OUT_TMP_DIR }}
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            RUN_ALL="${{ github.event.inputs.run_all }}"
            CATEGORY="${{ github.event.inputs.category }}"
            START="${{ github.event.inputs.start }}"
            PAGE_SIZE='${{ github.event.inputs.page_size }}'
            PAGE_STEP='${{ github.event.inputs.page_step }}'
            MAX_PAGES='${{ github.event.inputs.max_pages }}'
            HIGHLIGHT='${{ github.event.inputs.highlight }}'
          else
            RUN_ALL="true"; CATEGORY=""; START=""; PAGE_SIZE=""; PAGE_STEP=""; MAX_PAGES=""; HIGHLIGHT="51"
          fi

          ARGS=""
          if [[ "${RUN_ALL}" == "true" || "${RUN_ALL}" == "True" ]]; then
            ARGS+=" --all"
          else
            if [[ -z "${CATEGORY}" ]]; then
              echo "‚ùå Debes indicar 'category' cuando run_all=false."
              exit 1
            fi
            ARGS+=" -c ${CATEGORY}"
          fi
          [[ -n "${START}" ]] && ARGS+=" --start ${START}"
          [[ -n "${PAGE_SIZE}" ]] && ARGS+=" --page-size ${PAGE_SIZE}"
          [[ -n "${PAGE_STEP}" ]] && ARGS+=" --page-step ${PAGE_STEP}"
          [[ -n "${MAX_PAGES}" ]] && ARGS+=" --max-pages ${MAX_PAGES}"
          [[ -n "${HIGHLIGHT}" ]] && ARGS+=" --highlight ${HIGHLIGHT}"

          echo "‚ñ∂ python palacio_category_snapshot.py ${ARGS}"
          python palacio_category_snapshot.py ${ARGS}

      - name: Build consolidated Excels (ALL & CHANGES-only)
        if: always()
        run: |
          python - << 'PY'
          import pandas as pd, glob, os, pathlib
          base = pathlib.Path(os.environ.get("OUT_TMP_DIR","/tmp/ph"))
          files = glob.glob(str(base / "**/*_snapshot_*.xlsx"), recursive=True)

          def read_sheet(path, sheet):
            try:
              df = pd.read_excel(path, sheet_name=sheet, engine="openpyxl")
            except Exception:
              return None
            if df is None or df.empty or (set(df.columns) == {"info"}):
              return None
            parts = pathlib.Path(path).parts
            cat = parts[-3] if len(parts) >= 3 else ""
            df.insert(0, "category", cat)
            df.insert(1, "snapshot_file", os.path.basename(path))
            return df

          dfs_changes, dfs_new, dfs_removed = [], [], []
          for f in files:
            c = read_sheet(f, "CHANGES")
            n = read_sheet(f, "NEW")
            r = read_sheet(f, "REMOVED")
            if c is not None: dfs_changes.append(c)
            if n is not None: dfs_new.append(n)
            if r is not None: dfs_removed.append(r)

          out_changes = pd.concat(dfs_changes, ignore_index=True) if dfs_changes else pd.DataFrame({"info": ["Sin cambios detectados"]})
          out_new     = pd.concat(dfs_new,     ignore_index=True) if dfs_new     else pd.DataFrame({"info": ["Sin nuevos productos"]})
          out_removed = pd.concat(dfs_removed, ignore_index=True) if dfs_removed else pd.DataFrame({"info": ["Sin productos removidos"]})

          base.mkdir(parents=True, exist_ok=True)
          run_id = os.environ.get('GITHUB_RUN_ID','local')
          path_all = base / f"ALL_DIFFS_{run_id}.xlsx"
          path_changes = base / f"ALL_DIFFS_CHANGES_{run_id}.xlsx"

          with pd.ExcelWriter(path_all, engine="xlsxwriter") as w:
            out_changes.to_excel(w, index=False, sheet_name="CHANGES")
            out_new.to_excel(w, index=False, sheet_name="NEW")
            out_removed.to_excel(w, index=False, sheet_name="REMOVED")

          with pd.ExcelWriter(path_changes, engine="xlsxwriter") as w:
            out_changes.to_excel(w, index=False, sheet_name="CHANGES")

          print("‚úì Generados:", path_all, "y", path_changes)
          PY

      - name: (Push) Subir /tmp/ph completo a Drive
        if: always()
        run: |
          rclone copy "${OUT_TMP_DIR}" "${DRIVE_DEST}" --create-empty-src-dirs -P

      - name: Email cada XLSX de categor√≠a (sin ZIPs)
        if: always()
        env:
          EMAIL_HOST: smtp.gmail.com
          EMAIL_PORT: "587"
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO:   ${{ secrets.EMAIL_TO }}
          OUT_TMP_DIR: ${{ env.OUT_TMP_DIR }}
        run: |
          python - << 'PY'
          import os, glob, smtplib, ssl, mimetypes, pathlib
          from email.message import EmailMessage

          user = os.environ["EMAIL_USER"]; pwd=os.environ["EMAIL_PASS"]; to=os.environ["EMAIL_TO"]
          base = pathlib.Path(os.environ["OUT_TMP_DIR"])
          files = sorted(glob.glob(str(base / "**/*_snapshot_*.xlsx"), recursive=True))
          if not files:
            print("No hay XLSX por categor√≠a para enviar."); raise SystemExit(0)

          def send_one(fpath):
            msg = EmailMessage()
            msg["From"] = user
            msg["To"] = to
            msg["Subject"] = "[Scraper] Snapshot categor√≠a"
            msg.set_content(f"Adjunto snapshot: {os.path.basename(fpath)}")
            ctype, _ = mimetypes.guess_type(fpath)
            if not ctype: ctype = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
            maintype, subtype = ctype.split("/",1)
            with open(fpath, "rb") as f:
              msg.add_attachment(f.read(), maintype=maintype, subtype=subtype, filename=os.path.basename(fpath))
            cx = smtplib.SMTP(os.environ["EMAIL_HOST"], int(os.environ["EMAIL_PORT"]))
            cx.ehlo(); cx.starttls(context=ssl.create_default_context()); cx.ehlo()
            cx.login(user, pwd); cx.send_message(msg); cx.quit()
            print("üìß Enviado:", fpath)

          for f in files:
            try: send_one(f)
            except Exception as e: print("‚ö†Ô∏è Fall√≥ env√≠o", f, e)

          PY

      - name: Email consolidado SOLO CHANGES
        if: always()
        env:
          EMAIL_HOST: smtp.gmail.com
          EMAIL_PORT: "587"
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO:   ${{ secrets.EMAIL_TO }}
          OUT_TMP_DIR: ${{ env.OUT_TMP_DIR }}
        run: |
          python - << 'PY'
          import os, smtplib, ssl, mimetypes, pathlib
          from email.message import EmailMessage

          run_id = os.environ.get("GITHUB_RUN_ID","")
          xlsx = pathlib.Path(os.environ["OUT_TMP_DIR"]) / f"ALL_DIFFS_CHANGES_{run_id}.xlsx"
          user=os.environ["EMAIL_USER"]; pwd=os.environ["EMAIL_PASS"]; to=os.environ["EMAIL_TO"]

          msg = EmailMessage()
          msg["From"] = user; msg["To"] = to
          msg["Subject"] = "[Scraper] Consolidado SOLO CHANGES"
          body = "Adjunto el Excel con los cambios de precio agregados de todas las categor√≠as."
          if not xlsx.exists():
            body = "No se gener√≥ consolidado CHANGES. Revisa los logs."
          msg.set_content(body)

          if xlsx.exists():
            ctype, _ = mimetypes.guess_type(str(xlsx))
            if not ctype: ctype = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
            maintype, subtype = ctype.split("/",1)
            with open(xlsx, "rb") as f:
              msg.add_attachment(f.read(), maintype=maintype, subtype=subtype, filename=xlsx.name)
            print("Adjuntado:", xlsx)

          cx = smtplib.SMTP(os.environ["EMAIL_HOST"], int(os.environ["EMAIL_PORT"]))
          cx.ehlo(); cx.starttls(context=ssl.create_default_context()); cx.ehlo()
          cx.login(user, pwd); cx.send_message(msg); cx.quit()
          print("üìß Enviado SOLO CHANGES")
          PY

      - name: Cleanup
        if: always()
        run: rm -rf "$OUT_TMP_DIR" || true
