name: Palacio Scraper (Drive + Email + Matrix)

on:
  schedule:
    - cron: "0 8,20 * * *"
  workflow_dispatch:
    inputs:
      category:
        description: "Solo 1 categorÃ­a (vacÃ­o = todas)"
        type: string
        required: false
        default: ""

permissions:
  contents: read

concurrency:
  group: palacio-scraper
  cancel-in-progress: false

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    strategy:
      fail-fast: false
      max-parallel: 6
      matrix:
  category: ${{ fromJSON( (github.event_name == 'workflow_dispatch' && github.event.inputs.category != '') && format('["{0}"]', github.event.inputs.category) || '["ofertas","electronica","deportes","gourmet","casapalacio","nuevos-productos","mujer","productos-liquidacion","hombre","calzado","mujer-multimarcas","hombre-multimarcas","electronica-tablets","disenadores","hogar","juguetes","categorias","salas","tendencias","mas-vendido"]' ) }}

    env:
      EMAIL_HOST: smtp.gmail.com
      EMAIL_PORT: "587"
      EMAIL_USER: ${{ secrets.EMAIL_USER }}
      EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
      EMAIL_TO:   ${{ secrets.EMAIL_TO }}
      RCLONE_CONFIG: ${{ secrets.RCLONE_CONFIG }}
      RCLONE_REMOTE: ${{ secrets.RCLONE_REMOTE }}
      GDRIVE_BASE_PATH: ${{ secrets.GDRIVE_BASE_PATH }}
      GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install -U pip
          pip install requests pandas beautifulsoup4 xlsxwriter openpyxl pyarrow

      - name: Install rclone
        run: |
          curl -L -o rclone.zip https://downloads.rclone.org/rclone-current-linux-amd64.zip
          unzip -q rclone.zip
          sudo mv rclone-*-linux-amd64/rclone /usr/local/bin/rclone
          rclone version

      - name: Write rclone.conf
        env:
          RCLONE_CONFIG: ${{ env.RCLONE_CONFIG }}
        run: |
          mkdir -p ~/.config/rclone
          (echo "$RCLONE_CONFIG" | base64 -d > ~/.config/rclone/rclone.conf) || \
          (echo "$RCLONE_CONFIG" > ~/.config/rclone/rclone.conf)
          rclone listremotes || true

      - name: Pull previous snapshots from Drive
        shell: bash
        run: |
          set -euo pipefail
          CAT="${{ matrix.category }}"
          if [ -n "${RCLONE_REMOTE:-}" ] && [ -n "${GDRIVE_BASE_PATH:-}" ]; then
            src="${RCLONE_REMOTE}:${GDRIVE_BASE_PATH}/palacio_${CAT// /_}"
            rclone copy "$src" "out_palacio/palacio_${CAT// /_}" --create-empty-src-dirs -P || true
          elif [ -n "${GDRIVE_FOLDER_ID:-}" ]; then
            rclone copy ":drive,root_folder_id=${GDRIVE_FOLDER_ID}:" "out_palacio" --create-empty-src-dirs -P || true
          fi
          ls -R out_palacio || true

      - name: Run ONE category
        timeout-minutes: 300
        run: |
          python palacio_category_snapshot.py -c "${{ matrix.category }}" --out-dir out_palacio

      - name: Push category folder to Drive
        if: always()
        run: |
          set -euo pipefail
          CAT="${{ matrix.category }}"
          if [ -d "out_palacio/palacio_${CAT// /_}" ]; then
            if [ -n "${RCLONE_REMOTE:-}" ] && [ -n "${GDRIVE_BASE_PATH:-}" ]; then
              dst="${RCLONE_REMOTE}:${GDRIVE_BASE_PATH}/palacio_${CAT// /_}"
              rclone copy "out_palacio/palacio_${CAT// /_}" "$dst" --create-empty-src-dirs -P
            elif [ -n "${GDRIVE_FOLDER_ID:-}" ]; then
              rclone copy "out_palacio" ":drive,root_folder_id=${GDRIVE_FOLDER_ID}:" --create-empty-src-dirs -P
            fi
          fi

      - name: Upload artifacts (this category)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cat-${{ matrix.category }}-${{ github.run_id }}
          path: out_palacio/palacio_${{ matrix.category }}/**
          if-no-files-found: warn
          retention-days: 7

  consolidate:
    needs: scrape
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      EMAIL_HOST: smtp.gmail.com
      EMAIL_PORT: "587"
      EMAIL_USER: ${{ secrets.EMAIL_USER }}
      EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
      EMAIL_TO:   ${{ secrets.EMAIL_TO }}
      RCLONE_CONFIG: ${{ secrets.RCLONE_CONFIG }}
      RCLONE_REMOTE: ${{ secrets.RCLONE_REMOTE }}
      GDRIVE_BASE_PATH: ${{ secrets.GDRIVE_BASE_PATH }}
      GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install -U pip
          pip install pandas openpyxl xlsxwriter

      - name: Download all category artifacts
        uses: actions/download-artifact@v4
        with:
          path: all_out

      - name: Build ALL_DIFFS & email summary
        run: |
          python - << 'PY'
          import os, glob, pandas as pd, pathlib, smtplib, ssl
          from email.message import EmailMessage
          base = pathlib.Path("all_out")
          files = glob.glob(str(base / "**/*_snapshot_*.xlsx"), recursive=True)
          def read_sheet(path, sheet):
            try: df = pd.read_excel(path, sheet_name=sheet, engine="openpyxl")
            except: return None
            if df is None or df.empty or (set(df.columns)=={"info"}): return None
            parts = pathlib.Path(path).parts
            cat = ""
            for p in parts:
              if p.startswith("palacio_"): cat = p.replace("palacio_","")
            df.insert(0,"category",cat); df.insert(1,"snapshot_file",os.path.basename(path))
            return df
          dfs_c, dfs_n, dfs_r, counts = [], [], [], {}
          for f in files:
            c = read_sheet(f,"CHANGES"); n = read_sheet(f,"NEW"); r = read_sheet(f,"REMOVED")
            cat = ""
            for df in (c,n,r):
              if df is not None: cat = cat or df["category"].iloc[0]
            if c is not None: dfs_c.append(c)
            if n is not None: dfs_n.append(n)
            if r is not None: dfs_r.append(r)
            if cat:
              counts.setdefault(cat, {"changes":0,"new":0,"removed":0})
              counts[cat]["changes"] += 0 if c is None else len(c)
              counts[cat]["new"]     += 0 if n is None else len(n)
              counts[cat]["removed"] += 0 if r is None else len(r)
          out = pathlib.Path("consolidated"); out.mkdir(exist_ok=True)
          run_id = os.environ.get("GITHUB_RUN_ID","local")
          path_all = out / f"ALL_DIFFS_{run_id}.xlsx"
          out_c = pd.concat(dfs_c, ignore_index=True) if dfs_c else pd.DataFrame({"info":["Sin cambios detectados"]})
          out_n = pd.concat(dfs_n, ignore_index=True) if dfs_n else pd.DataFrame({"info":["Sin nuevos productos"]})
          out_r = pd.concat(dfs_r, ignore_index=True) if dfs_r else pd.DataFrame({"info":["Sin productos removidos"]})
          with pd.ExcelWriter(path_all, engine="xlsxwriter") as w:
            out_c.to_excel(w, index=False, sheet_name="CHANGES")
            out_n.to_excel(w, index=False, sheet_name="NEW")
            out_r.to_excel(w, index=False, sheet_name="REMOVED")
          user=os.environ.get("EMAIL_USER",""); pwd=os.environ.get("EMAIL_PASS",""); to=os.environ.get("EMAIL_TO","")
          if user and pwd and to:
            lines=["Resumen cambios:"]
            for k in sorted(counts.keys()):
              v=counts[k]; lines.append(f"  - {k}: Î”{v['changes']}  +{v['new']}  -{v['removed']}")
            if len(lines)==1: lines.append("  (sin cambios)")
            msg=EmailMessage(); msg["From"]=user; msg["To"]=to; msg["Subject"]="[Scraper] Resumen consolidado (ALL_DIFFS)"
            msg.set_content("\n".join(lines))
            with open(path_all,"rb") as f:
              msg.add_attachment(f.read(), maintype="application", subtype="vnd.openxmlformats-officedocument.spreadsheetml.sheet", filename=path_all.name)
            cx=smtplib.SMTP(os.environ["EMAIL_HOST"], int(os.environ["EMAIL_PORT"])); cx.ehlo(); cx.starttls(context=ssl.create_default_context()); cx.ehlo(); cx.login(user,pwd); cx.send_message(msg); cx.quit()
            print("ðŸ“§ Resumen consolidado enviado.")
          else:
            print("âš ï¸ Faltan credenciales de email; no se envÃ­a consolidado.")
          PY

      - name: Upload consolidated to Drive
        if: always()
        run: |
          curl -L -o rclone.zip https://downloads.rclone.org/rclone-current-linux-amd64.zip
          unzip -q rclone.zip
          sudo mv rclone-*-linux-amd64/rclone /usr/local/bin/rclone
          mkdir -p ~/.config/rclone
          (echo "$RCLONE_CONFIG" | base64 -d > ~/.config/rclone/rclone.conf) || \
          (echo "$RCLONE_CONFIG" > ~/.config/rclone/rclone.conf)
          if [ -n "${RCLONE_REMOTE:-}" ] && [ -n "${GDRIVE_BASE_PATH:-}" ]; then
            rclone copy "consolidated" "${RCLONE_REMOTE}:${GDRIVE_BASE_PATH}/_consolidated" -P
          elif [ -n "${GDRIVE_FOLDER_ID:-}" ]; then
            rclone copy "consolidated" ":drive,root_folder_id=${GDRIVE_FOLDER_ID}:" -P
          fi

      - name: Upload consolidated artifact
        uses: actions/upload-artifact@v4
        with:
          name: consolidated-${{ github.run_id }}
          path: consolidated/**
          retention-days: 10
