name: Palacio Scraper (Drive + Emails por categor√≠a + Resumen CHANGES)

on:
  schedule:
    # 08:00 y 20:00 UTC ‚âà 02:00 y 14:00 CDMX
    - cron: "0 8,20 * * *"
  workflow_dispatch:
    inputs:
      category:
        description: "Categor√≠a √∫nica (dejar vac√≠o para todas en cron). Ej: juguetes"
        type: string
        required: false
        default: ""
      start:
        description: "Offset inicial start="
        type: string
        required: false
        default: ""
      page_size:
        description: "Tama√±o de p√°gina sz="
        type: string
        required: false
        default: ""
      page_step:
        description: "Salto de start"
        type: string
        required: false
        default: ""
      max_pages:
        description: "M√°ximo de p√°ginas"
        type: string
        required: false
        default: ""
      highlight:
        description: "Umbral % highlight"
        type: string
        required: false
        default: "51"

permissions:
  contents: read

concurrency:
  group: palacio-scraper
  cancel-in-progress: false

env:
  PY_VERSION: "3.11"

jobs:
  # ========================== A) MATRIZ (todas) ==========================
  scrape_all:
    if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.category == '' }}
    runs-on: ubuntu-latest
    timeout-minutes: 360
    strategy:
      fail-fast: false
      max-parallel: 6
      matrix:
        category:
          - ofertas
          - electronica
          - deportes
          - gourmet
          - casapalacio
          - nuevos-productos
          - mujer
          - productos-liquidacion
          - hombre
          - calzado
          - mujer-multimarcas
          - hombre-multimarcas
          - electronica-tablets
          - disenadores
          - hogar
          - juguetes
          - categorias
          - salas
          - tendencias
          - mas-vendido

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PY_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install requests pandas beautifulsoup4 xlsxwriter openpyxl pyarrow
          fi

      - name: Run category
        env:
          CAT:        ${{ matrix.category }}
          START:      ${{ github.event.inputs.start }}
          PAGE_SIZE:  ${{ github.event.inputs.page_size }}
          PAGE_STEP:  ${{ github.event.inputs.page_step }}
          MAX_PAGES:  ${{ github.event.inputs.max_pages }}
          HIGHLIGHT:  ${{ github.event.inputs.highlight }}
        run: |
          set -euo pipefail
          ARGS="-c ${CAT}"
          [[ -n "${START}" ]] && ARGS+=" --start ${START}"
          [[ -n "${PAGE_SIZE}" ]] && ARGS+=" --page-size ${PAGE_SIZE}"
          [[ -n "${PAGE_STEP}" ]] && ARGS+=" --page-step ${PAGE_STEP}"
          [[ -n "${MAX_PAGES}" ]] && ARGS+=" --max-pages ${MAX_PAGES}"
          [[ -n "${HIGHLIGHT}" ]] && ARGS+=" --highlight ${HIGHLIGHT}"
          echo "‚ñ∂ python palacio_category_snapshot.py ${ARGS}"
          python palacio_category_snapshot.py ${ARGS}

      - name: Email XLSX of this category (no zip)
        if: always()
        env:
          EMAIL_HOST: smtp.gmail.com
          EMAIL_PORT: "587"
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO:   ${{ secrets.EMAIL_TO }}
          CAT:        ${{ matrix.category }}
        run: |
          python - << 'PY'
          import os, smtplib, ssl, mimetypes, pathlib, glob
          from email.message import EmailMessage

          user = os.environ.get("EMAIL_USER","")
          pwd  = os.environ.get("EMAIL_PASS","")
          to   = os.environ.get("EMAIL_TO","")
          cat  = os.environ.get("CAT","")

          if not user or not pwd or not to:
            print("‚ö†Ô∏è Falta EMAIL_USER/EMAIL_PASS/EMAIL_TO; no se env√≠a correo.")
            raise SystemExit(0)

          base = pathlib.Path("out_palacio")
          files = sorted(glob.glob(str(base / f"{cat}" / "**" / "*.xlsx"), recursive=True))
          if not files:
            print(f"‚ÑπÔ∏è No hay XLSX para {cat}.")
            raise SystemExit(0)

          def size_mb(p): return os.path.getsize(p)/1024/1024
          batch, batch_sz = [], 0.0
          batches = []
          for f in files:
            s = size_mb(f)
            if batch and (batch_sz + s > 20.0):
              batches.append(batch)
              batch, batch_sz = [], 0.0
            batch.append(f); batch_sz += s
          if batch: batches.append(batch)

          for i, group in enumerate(batches, 1):
            msg = EmailMessage()
            msg["From"] = user
            msg["To"] = to
            msg["Subject"] = f"[Scraper] XLSX {cat} (lote {i}/{len(batches)})"
            msg.set_content(f"Adjunto XLSX generados para la categor√≠a {cat}. Lote {i}/{len(batches)}.")

            for path in group:
              ctype, _ = mimetypes.guess_type(path)
              if not ctype:
                ctype = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
              maintype, subtype = ctype.split("/", 1)
              with open(path, "rb") as f:
                msg.add_attachment(f.read(), maintype=maintype, subtype=subtype, filename=os.path.basename(path))
              print("Adjuntado:", path)

            cx = smtplib.SMTP(os.environ["EMAIL_HOST"], int(os.environ["EMAIL_PORT"]))
            cx.ehlo(); cx.starttls(context=ssl.create_default_context()); cx.ehlo()
            cx.login(user, pwd)
            cx.send_message(msg)
            cx.quit()
            print(f"üìß Enviado lote {i}/{len(batches)} para {cat}")
          PY

      - name: Upload artifact (out_palacio for this category)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: out_palacio-${{ matrix.category }}-${{ github.run_id }}
          path: out_palacio/**
          if-no-files-found: warn
          retention-days: 10

      - name: Install rclone
        if: always()
        run: |
          set -euo pipefail
          curl -L -o rclone.zip https://downloads.rclone.org/rclone-current-linux-amd64.zip
          unzip -q rclone.zip
          sudo mv rclone-*-linux-amd64/rclone /usr/local/bin/rclone
          rclone version

      - name: Write rclone.conf from secret
        if: always()
        env:
          RCLONE_CONFIG: ${{ secrets.RCLONE_CONFIG }}
        run: |
          set -euo pipefail
          mkdir -p ~/.config/rclone
          (echo "$RCLONE_CONFIG" | base64 -d > ~/.config/rclone/rclone.conf) || \
          (echo "$RCLONE_CONFIG" > ~/.config/rclone/rclone.conf)
          rclone listremotes || true

      - name: Upload to Drive via rclone (per-category)
        if: always()
        env:
          RCLONE_REMOTE: ${{ secrets.RCLONE_REMOTE }}
        run: |
          set -euo pipefail
          REMOTE="${RCLONE_REMOTE:-mydrive:}"
          if [ -d "out_palacio" ]; then
            # Ej: mydrive:Scrapper-PH/out_palacio/<todo lo generado>
            rclone copy "out_palacio" "${REMOTE}Scrapper-PH/out_palacio" --create-empty-src-dirs -P
            echo "‚úì Upload terminado a ${REMOTE}Scrapper-PH/out_palacio"
          else
            echo "‚ö†Ô∏è No existe out_palacio; nada que subir."
          fi

  # ========================== B) UNA SOLA (manual) ==========================
  scrape_one:
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.category != '' }}
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PY_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install requests pandas beautifulsoup4 xlsxwriter openpyxl pyarrow
          fi

      - name: Run single category
        env:
          CAT:        ${{ github.event.inputs.category }}
          START:      ${{ github.event.inputs.start }}
          PAGE_SIZE:  ${{ github.event.inputs.page_size }}
          PAGE_STEP:  ${{ github.event.inputs.page_step }}
          MAX_PAGES:  ${{ github.event.inputs.max_pages }}
          HIGHLIGHT:  ${{ github.event.inputs.highlight }}
        run: |
          set -euo pipefail
          ARGS="-c ${CAT}"
          [[ -n "${START}" ]] && ARGS+=" --start ${START}"
          [[ -n "${PAGE_SIZE}" ]] && ARGS+=" --page-size ${PAGE_SIZE}"
          [[ -n "${PAGE_STEP}" ]] && ARGS+=" --page-step ${PAGE_STEP}"
          [[ -n "${MAX_PAGES}" ]] && ARGS+=" --max-pages ${MAX_PAGES}"
          [[ -n "${HIGHLIGHT}" ]] && ARGS+=" --highlight ${HIGHLIGHT}"
          echo "‚ñ∂ python palacio_category_snapshot.py ${ARGS}"
          python palacio_category_snapshot.py ${ARGS}

      - name: Email XLSX of this category (no zip)
        if: always()
        env:
          EMAIL_HOST: smtp.gmail.com
          EMAIL_PORT: "587"
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO:   ${{ secrets.EMAIL_TO }}
          CAT:        ${{ github.event.inputs.category }}
        run: |
          python - << 'PY'
          import os, smtplib, ssl, mimetypes, pathlib, glob
          from email.message import EmailMessage

          user = os.environ.get("EMAIL_USER","")
          pwd  = os.environ.get("EMAIL_PASS","")
          to   = os.environ.get("EMAIL_TO","")
          cat  = os.environ.get("CAT","")

          if not user or not pwd or not to:
            print("‚ö†Ô∏è Falta EMAIL_USER/EMAIL_PASS/EMAIL_TO; no se env√≠a correo.")
            raise SystemExit(0)

          base = pathlib.Path("out_palacio")
          files = sorted(glob.glob(str(base / f"{cat}" / "**" / "*.xlsx"), recursive=True))
          if not files:
            print(f"‚ÑπÔ∏è No hay XLSX para {cat}.")
            raise SystemExit(0)

          def size_mb(p): return os.path.getsize(p)/1024/1024
          batch, batch_sz = [], 0.0
          batches = []
          for f in files:
            s = size_mb(f)
            if batch and (batch_sz + s > 20.0):
              batches.append(batch)
              batch, batch_sz = [], 0.0
            batch.append(f); batch_sz += s
          if batch: batches.append(batch)

          for i, group in enumerate(batches, 1):
            msg = EmailMessage()
            msg["From"] = user
            msg["To"] = to
            msg["Subject"] = f"[Scraper] XLSX {cat} (lote {i}/{len(batches)})"
            msg.set_content(f"Adjunto XLSX generados para la categor√≠a {cat}. Lote {i}/{len(batches)}.")

            for path in group:
              ctype, _ = mimetypes.guess_type(path)
              if not ctype:
                ctype = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
              maintype, subtype = ctype.split("/", 1)
              with open(path, "rb") as f:
                msg.add_attachment(f.read(), maintype=maintype, subtype=subtype, filename=os.path.basename(path))
              print("Adjuntado:", path)

            cx = smtplib.SMTP(os.environ["EMAIL_HOST"], int(os.environ["EMAIL_PORT"]))
            cx.ehlo(); cx.starttls(context=ssl.create_default_context()); cx.ehlo()
            cx.login(user, pwd)
            cx.send_message(msg)
            cx.quit()
            print(f"üìß Enviado lote {i}/{len(batches)} para {cat}")
          PY

      - name: Upload artifact (out_palacio for this category)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: out_palacio-${{ github.event.inputs.category }}-${{ github.run_id }}
          path: out_palacio/**
          if-no-files-found: warn
          retention-days: 10

      - name: Install rclone
        if: always()
        run: |
          set -euo pipefail
          curl -L -o rclone.zip https://downloads.rclone.org/rclone-current-linux-amd64.zip
          unzip -q rclone.zip
          sudo mv rclone-*-linux-amd64/rclone /usr/local/bin/rclone
          rclone version

      - name: Write rclone.conf from secret
        if: always()
        env:
          RCLONE_CONFIG: ${{ secrets.RCLONE_CONFIG }}
        run: |
          set -euo pipefail
          mkdir -p ~/.config/rclone
          (echo "$RCLONE_CONFIG" | base64 -d > ~/.config/rclone/rclone.conf) || \
          (echo "$RCLONE_CONFIG" > ~/.config/rclone/rclone.conf)
          rclone listremotes || true

      - name: Upload to Drive via rclone (single category)
        if: always()
        env:
          RCLONE_REMOTE: ${{ secrets.RCLONE_REMOTE }}
        run: |
          set -euo pipefail
          REMOTE="${RCLONE_REMOTE:-mydrive:}"
          if [ -d "out_palacio" ]; then
            rclone copy "out_palacio" "${REMOTE}Scrapper-PH/out_palacio" --create-empty-src-dirs -P
            echo "‚úì Upload terminado a ${REMOTE}Scrapper-PH/out_palacio"
          else
            echo "‚ö†Ô∏è No existe out_palacio; nada que subir."
          fi

  # ========================== C) CONSOLIDACI√ìN ==========================
  consolidate:
    needs: [scrape_all, scrape_one]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: .
          merge-multiple: true

      - name: Show tree
        run: |
          echo "Contenido descargado:"
          ls -R

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PY_VERSION }}

      - name: Install deps (consolidation)
        run: |
          python -m pip install -U pip
          pip install pandas openpyxl xlsxwriter

      - name: Build consolidated Excels (ALL & CHANGES-only)
        run: |
          python - << 'PY'
          import pandas as pd, glob, os, pathlib
          base = pathlib.Path("out_palacio")
          files = glob.glob(str(base / "**/*_snapshot_*.xlsx"), recursive=True)

          def read_sheet(path, sheet):
            try:
              df = pd.read_excel(path, sheet_name=sheet, engine="openpyxl")
            except Exception:
              return None
            if df is None or df.empty or (set(df.columns) == {"info"}):
              return None
            parts = pathlib.Path(path).parts
            # out_palacio/<categoria>/<YYYY-MM>/<file.xlsx>
            cat = parts[-3] if len(parts) >= 3 else ""
            df.insert(0, "category", cat)
            df.insert(1, "snapshot_file", os.path.basename(path))
            return df

          dfs_changes, dfs_new, dfs_removed = [], [], []
          for f in files:
            c = read_sheet(f, "CHANGES")
            n = read_sheet(f, "NEW")
            r = read_sheet(f, "REMOVED")
            if c is not None: dfs_changes.append(c)
            if n is not None: dfs_new.append(n)
            if r is not None: dfs_removed.append(r)

          out_changes = pd.concat(dfs_changes, ignore_index=True) if dfs_changes else pd.DataFrame({"info": ["Sin cambios detectados"]})
          out_new     = pd.concat(dfs_new,     ignore_index=True) if dfs_new     else pd.DataFrame({"info": ["Sin nuevos productos"]})
          out_removed = pd.concat(dfs_removed, ignore_index=True) if dfs_removed else pd.DataFrame({"info": ["Sin productos removidos"]})

          base.mkdir(parents=True, exist_ok=True)
          run_id = os.environ.get('GITHUB_RUN_ID','local')
          path_all = base / f"ALL_DIFFS_{run_id}.xlsx"
          path_changes = base / f"ALL_DIFFS_CHANGES_{run_id}.xlsx"

          with pd.ExcelWriter(path_all, engine="xlsxwriter") as w:
            out_changes.to_excel(w, index=False, sheet_name="CHANGES")
            out_new.to_excel(w, index=False, sheet_name="NEW")
            out_removed.to_excel(w, index=False, sheet_name="REMOVED")

          with pd.ExcelWriter(path_changes, engine="xlsxwriter") as w:
            out_changes.to_excel(w, index=False, sheet_name="CHANGES")

          print("‚úì Generados:", path_all, "y", path_changes)
          PY

      - name: Upload consolidated artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ALL_DIFFS-${{ github.run_id }}
          path: |
            out_palacio/ALL_DIFFS_${{ github.run_id }}.xlsx
            out_palacio/ALL_DIFFS_CHANGES_${{ github.run_id }}.xlsx
          if-no-files-found: warn
          retention-days: 10

      - name: Install rclone
        run: |
          set -euo pipefail
          curl -L -o rclone.zip https://downloads.rclone.org/rclone-current-linux-amd64.zip
          unzip -q rclone.zip
          sudo mv rclone-*-linux-amd64/rclone /usr/local/bin/rclone
          rclone version

      - name: Write rclone.conf from secret
        env:
          RCLONE_CONFIG: ${{ secrets.RCLONE_CONFIG }}
        run: |
          set -euo pipefail
          mkdir -p ~/.config/rclone
          (echo "$RCLONE_CONFIG" | base64 -d > ~/.config/rclone/rclone.conf) || \
          (echo "$RCLONE_CONFIG" > ~/.config/rclone/rclone.conf)
          rclone listremotes || true

      - name: Upload consolidated to Drive (rclone)
        env:
          RCLONE_REMOTE: ${{ secrets.RCLONE_REMOTE }}
        run: |
          set -euo pipefail
          REMOTE="${RCLONE_REMOTE:-mydrive:}"
          if [ -d "out_palacio" ]; then
            rclone copy "out_palacio/ALL_DIFFS_${{ github.run_id }}.xlsx"        "${REMOTE}Scrapper-PH/consolidados" -P || true
            rclone copy "out_palacio/ALL_DIFFS_CHANGES_${{ github.run_id }}.xlsx" "${REMOTE}Scrapper-PH/consolidados" -P || true
            echo "‚úì Consolidado subido a ${REMOTE}Scrapper-PH/consolidados"
          else
            echo "‚ö†Ô∏è No existe out_palacio; nada que subir."
          fi

      - name: Email ONLY CHANGES Excel
        env:
          EMAIL_HOST: smtp.gmail.com
          EMAIL_PORT: "587"
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO:   ${{ secrets.EMAIL_TO }}
        run: |
          python - << 'PY'
          import os, smtplib, ssl, mimetypes, pathlib
          from email.message import EmailMessage
          run_id = os.environ.get("GITHUB_RUN_ID")
          xlsx_path = f"out_palacio/ALL_DIFFS_CHANGES_{run_id}.xlsx"
          user = os.environ.get("EMAIL_USER","")
          pwd  = os.environ.get("EMAIL_PASS","")
          to   = os.environ.get("EMAIL_TO","")

          if not user or not pwd or not to:
            print("‚ö†Ô∏è Falta EMAIL_USER/EMAIL_PASS/EMAIL_TO; no se env√≠a correo.")
            raise SystemExit(0)

          msg = EmailMessage()
          msg["From"] = user
          msg["To"] = to
          msg["Subject"] = "[Scraper] Consolidado SOLO CHANGES"
          body = "Adjunto Excel consolidado con CHANGES de esta corrida."
          if not pathlib.Path(xlsx_path).exists():
            body = "No hubo CHANGES consolidado. Revisa logs."
          msg.set_content(body)

          if pathlib.Path(xlsx_path).exists():
            ctype, _ = mimetypes.guess_type(xlsx_path)
            if not ctype: ctype = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
            maintype, subtype = ctype.split("/", 1)
            with open(xlsx_path, "rb") as f:
              msg.add_attachment(f.read(), maintype=maintype, subtype=subtype, filename=os.path.basename(xlsx_path))
            print("Adjuntado:", xlsx_path)

          cx = smtplib.SMTP(os.environ["EMAIL_HOST"], int(os.environ["EMAIL_PORT"]))
          cx.ehlo(); cx.starttls(context=ssl.create_default_context()); cx.ehlo()
          cx.login(user, pwd)
          cx.send_message(msg)
          cx.quit()
          print("üìß Enviado SOLO CHANGES")
          PY
