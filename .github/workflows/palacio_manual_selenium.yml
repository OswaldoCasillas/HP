name: Palacio Manual Runner (Selenium v2)

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Modo de ejecución"
        type: choice
        required: true
        default: preset
        options:
          - preset
          - urls
          - search
          - discover

      preset:
        description: "Preset principal (dropdown)"
        type: choice
        required: true
        default: mujer
        options:
          - hombre
          - mujer
          - belleza
          - hogar
          - gourmet
          - marcas
          - ofertas
          - lo_mas_vendido
          - deportes
          - marcas_nuevas
          - calzado
          - calzado_mujer
          - zapatos_hombre

      more_presets:
        description: "Opcional: más presets (coma). Ej: ofertas,deportes"
        type: string
        required: false
        default: ""

      urls:
        description: "URLs (una por línea) (solo si mode=urls)"
        type: string
        required: false
        default: ""

      search_term:
        description: "Palabra/frase para buscar (solo si mode=search). Ej: navidad o 'botas mujer' (admite coma)"
        type: string
        required: false
        default: ""

      max_pages:
        description: "Máx páginas por URL (entero). Ej: 2, 5, 10"
        type: string
        required: true
        default: "2"

      headless:
        description: "Correr Chrome en headless (recomendado en GitHub Actions)"
        type: boolean
        required: true
        default: true

      discount_threshold:
        description: "Umbral % descuento para alertas por marcas (watchlist). Ej: 51"
        type: string
        required: true
        default: "51"

      send_email:
        description: "Enviar alertas por correo (solo si hay NEW/CHANGED + descuento + marca en watchlist)"
        type: boolean
        required: true
        default: false

      upload_drive:
        description: "Subir resultados a Google Drive (XLSX + history/*.parquet)"
        type: boolean
        required: true
        default: true

permissions:
  contents: read

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 330

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Setup Chrome (stable)
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable
          install-dependencies: true

      - name: Install rclone (si upload_drive=true)
        if: ${{ inputs.upload_drive }}
        run: |
          sudo apt-get update
          sudo apt-get install -y rclone

      - name: Prepare urls.txt (si mode=urls)
        if: ${{ inputs.mode == 'urls' }}
        run: |
          printf "%s" "${{ inputs.urls }}" > urls.txt
          echo "urls.txt:"
          sed -n '1,120p' urls.txt

      - name: Setup rclone config (si upload_drive=true)
        if: ${{ inputs.upload_drive }}
        env:
          RCLONE_CONF_TEXT: ${{ secrets.RCLONE_CONFIG }}
        run: |
          set -euo pipefail
          mkdir -p ~/.config/rclone
          printf "%s" "$RCLONE_CONF_TEXT" > ~/.config/rclone/rclone.conf
          rclone version
          rclone listremotes

      - name: Pull history snapshots (si upload_drive=true)
        if: ${{ inputs.upload_drive }}
        run: |
          set -euo pipefail
          mkdir -p outputs/history
          rclone copy "gdrive:manual" "outputs/history" --include "*_snapshot_*.parquet" -v --retries 3 || true
          ls -lh outputs/history || true

      - name: Run scraper
        env:
          BRAND_WATCHLIST: ${{ secrets.BRAND_WATCHLIST }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          EMAIL_TO:   ${{ secrets.EMAIL_TO }}
        shell: bash
        run: |
          set -euo pipefail

          args=(--max-pages "${{ inputs.max_pages }}"
                --headless "${{ inputs.headless }}"
                --discount-threshold "${{ inputs.discount_threshold }}"
                --send-email "${{ inputs.send_email }}"
                --out-dir "outputs"
                --history-dir "outputs/history")

          if [[ "${{ inputs.mode }}" == "discover" ]]; then
            args+=(--discover true)
          elif [[ "${{ inputs.mode }}" == "urls" ]]; then
            args+=(--urls-file "urls.txt")
          elif [[ "${{ inputs.mode }}" == "search" ]]; then
            args+=(--search-term "${{ inputs.search_term }}")
          else
            preset="${{ inputs.preset }}"
            more="${{ inputs.more_presets }}"
            if [[ -n "${more// }" ]]; then
              preset="$preset,$more"
            fi
            args+=(--presets "$preset")
          fi

          echo "Running: python palacio_manual_runner_selenium_v2.py ${args[*]}"
          python palacio_manual_runner_selenium_v2.py "${args[@]}"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: outputs
          path: outputs/**

      - name: Upload outputs to Drive (si upload_drive=true)
        if: ${{ inputs.upload_drive }}
        run: |
          set -euo pipefail
          rclone copy "outputs" "gdrive:manual" \
            --include "*.xlsx" --include "history/*.parquet" \
            --create-empty-src-dirs -v --retries 3
