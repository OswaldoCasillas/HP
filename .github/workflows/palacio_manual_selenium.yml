name: Palacio Manual Runner (Selenium)

on:
  workflow_dispatch:
    inputs:
      presets:
        description: "Presets (comma). Ej: hombre,mujer,belleza. Vacío si usarás urls."
        required: false
        default: "hombre"
      urls:
        description: "URLs (una por línea). Si se llena, sobre-escribe presets."
        required: false
        default: ""
      max_pages:
        description: "Máx páginas por URL"
        required: false
        default: "8"
      headless:
        description: "true/false"
        required: false
        default: "true"
      discount_threshold:
        description: "Umbral % para alertas (watchlist)"
        required: false
        default: "51"
      send_email:
        description: "true/false"
        required: false
        default: "false"
      upload_drive:
        description: "true/false"
        required: false
        default: "true"

permissions:
  contents: read

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 330

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Setup Chrome
        uses: browser-actions/setup-chrome@v1

      - name: Write urls.txt
        if: ${{ inputs.urls != '' }}
        run: |
          printf "%s" "${{ inputs.urls }}" > urls.txt
          echo "urls.txt created:"
          sed -n '1,200p' urls.txt

      - name: Prepare rclone config
        if: ${{ inputs.upload_drive == 'true' }}
        env:
          RCLONE_CONF_TEXT: ${{ secrets.RCLONE_CONFIG }}
        run: |
          mkdir -p ~/.config/rclone
          printf "%s" "$RCLONE_CONF_TEXT" > ~/.config/rclone/rclone.conf
          rclone config show >/dev/null

      - name: Pull history snapshots (optional)
        if: ${{ inputs.upload_drive == 'true' }}
        env:
          RCLONE_REMOTE: ${{ secrets.RCLONE_REMOTE }}   # ej: gdrive
          DRIVE_FOLDER_ID: ${{ secrets.DRIVE_FOLDER_ID }}
        run: |
          mkdir -p outputs/history
          # trae parquets recientes para poder diffs
          rclone copy "${RCLONE_REMOTE}:${DRIVE_FOLDER_ID}" outputs/history \
            --include "*_snapshot_*.parquet" --max-age 45d || true

      - name: Run scraper
        env:
          BRAND_WATCHLIST: ${{ secrets.BRAND_WATCHLIST }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          EMAIL_TO:   ${{ secrets.EMAIL_TO }}
        run: |
          python palacio_manual_runner_selenium_v2.py \
            --presets "${{ inputs.presets }}" \
            --urls-file "${{ inputs.urls != '' && 'urls.txt' || '' }}" \
            --max-pages "${{ inputs.max_pages }}" \
            --headless "${{ inputs.headless }}" \
            --discount-threshold "${{ inputs.discount_threshold }}" \
            --send-email "${{ inputs.send_email }}" \
            --out-dir "outputs" \
            --history-dir "outputs/history"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: outputs
          path: outputs/**

      - name: Upload outputs to Drive
        if: ${{ inputs.upload_drive == 'true' }}
        env:
          RCLONE_REMOTE: ${{ secrets.RCLONE_REMOTE }}
          DRIVE_FOLDER_ID: ${{ secrets.DRIVE_FOLDER_ID }}
        run: |
          rclone copy outputs "${RCLONE_REMOTE}:${DRIVE_FOLDER_ID}" \
            --include "*.xlsx" --include "history/*.parquet" \
            --create-empty-src-dirs
