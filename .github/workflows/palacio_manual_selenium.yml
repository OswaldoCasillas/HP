name: Palacio Manual Runner (Selenium)

on:
  workflow_dispatch:
    inputs:
      category_or_url:
        description: "Número de categoría (1..N) o URL completa (si empieza con http)"
        required: true
        default: "2"  # 1=mujer, 2=hombre, 3=niña, 4=niño, 5=hogar, 6=belleza, 7=ofertas, o pega URL
      headless:
        description: "Headless? true/false"
        required: true
        default: "true"
      max_pages:
        description: "Máximo de páginas a recorrer"
        required: true
        default: "50"
      out_prefix:
        description: "Prefijo de archivos (para snapshots/alerts)"
        required: true
        default: "palacio_manual"

jobs:
  run-manual:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    env:
      SAVE_DIR: /tmp/palacio_out
      # Email (opcionales si quieres alertas)
      EMAIL_HOST:  ${{ secrets.EMAIL_HOST }}
      EMAIL_PORT:  ${{ secrets.EMAIL_PORT }}
      EMAIL_USER:  ${{ secrets.EMAIL_USER }}
      EMAIL_PASS:  ${{ secrets.EMAIL_PASS }}
      EMAIL_TO:    ${{ secrets.EMAIL_TO }}
      EMAIL_DEBUG: ${{ secrets.EMAIL_DEBUG }}
      # Alertas
      PALACIO_ALERT_BRANDS: ${{ secrets.PALACIO_ALERT_BRANDS }}
      ALERT_MIN_DISC: ${{ secrets.ALERT_MIN_DISC }}

      # Inputs -> ENV para el script
      HEADLESS: ${{ github.event.inputs.headless }}
      MAX_PAGES: ${{ github.event.inputs.max_pages }}
      OUT_PREFIX: ${{ github.event.inputs.out_prefix }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Resolver category/URL a ENV
        id: sel
        shell: bash
        run: |
          set -euo pipefail
          IN="${{ github.event.inputs.category_or_url }}"
          if [[ "$IN" =~ ^https?:// ]]; then
            echo "url=$IN" >> $GITHUB_OUTPUT
          else
            case "$IN" in
              1) echo "url=https://www.elpalaciodehierro.com/mujer/"   >> $GITHUB_OUTPUT ;;
              2) echo "url=https://www.elpalaciodehierro.com/hombre/"  >> $GITHUB_OUTPUT ;;
              3) echo "url=https://www.elpalaciodehierro.com/nina/"    >> $GITHUB_OUTPUT ;;
              4) echo "url=https://www.elpalaciodehierro.com/nino/"    >> $GITHUB_OUTPUT ;;
              5) echo "url=https://www.elpalaciodehierro.com/hogar/"   >> $GITHUB_OUTPUT ;;
              6) echo "url=https://www.elpalaciodehierro.com/belleza/" >> $GITHUB_OUTPUT ;;
              7) echo "url=https://www.elpalaciodehierro.com/outlet/"  >> $GITHUB_OUTPUT ;;
              *) echo "url=https://www.elpalaciodehierro.com/hombre/"  >> $GITHUB_OUTPUT ;;
            esac
          fi

      - name: Ejecutar runner manual
        env:
          TARGET_URL: ${{ steps.sel.outputs.url }}
        run: |
          python palacio_manual_runner_selenium.py <<EOF
          ${{ github.event.inputs.category_or_url }}
          ${{ env.HEADLESS }}
          ${{ env.MAX_PAGES }}
          ${{ env.OUT_PREFIX }}
          EOF

      - name: Subir artefactos (XLSX + PARQUET)
        uses: actions/upload-artifact@v4
        with:
          name: palacio-manual-outputs
          path: |
            /tmp/palacio_out/*.xlsx
            /tmp/palacio_out/*.parquet
          if-no-files-found: ignore
          retention-days: 5
