name: Palacio Manual (on-demand + alerts)

on:
  workflow_dispatch:
    inputs:
      category:
        description: "Categoría (opcional; si la omites y corres local, pregunta)"
        required: false
        type: choice
        options:
          - ofertas
          - electronica
          - deportes
          - gourmet
          - nuevos-productos
          - mujer
          - productos-liquidacion
          - hombre
          - calzado
          - hogar
          - juguetes
          - categorias
          - tendencias
          - "más vendido"
      start:
        description: "start (offset) opcional"
        required: false
      page_size:
        description: "sz (opcional)"
        required: false
      page_step:
        description: "step (opcional)"
        required: false
      max_pages:
        description: "max_pages (opcional)"
        required: false

jobs:
  run-manual:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    env:
      SAVE_DIR: /tmp/palacio_out
      EMAIL_HOST:  ${{ secrets.EMAIL_HOST }}
      EMAIL_PORT:  ${{ secrets.EMAIL_PORT }}
      EMAIL_USER:  ${{ secrets.EMAIL_USER }}
      EMAIL_PASS:  ${{ secrets.EMAIL_PASS }}
      EMAIL_TO:    ${{ secrets.EMAIL_TO }}
      EMAIL_DEBUG: ${{ secrets.EMAIL_DEBUG }}
      ALERT_BRANDS: ${{ secrets.ALERT_BRANDS }}
      GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas beautifulsoup4 xlsxwriter pyarrow

      - name: Install rclone (opcional Drive)
        run: |
          sudo apt-get update && sudo apt-get install -y rclone

      - name: Configure rclone (opcional)
        shell: bash
        env:
          RCLONE_CONFIG: ${{ secrets.RCLONE_CONFIG }}
          SA_JSON: ${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON }}
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        run: |
          set -euo pipefail
          mkdir -p ~/.config/rclone
          if [[ -n "${RCLONE_CONFIG:-}" ]]; then
            printf '%s\n' "$RCLONE_CONFIG" > ~/.config/rclone/rclone.conf
          elif [[ -n "${SA_JSON:-}" && -n "${GDRIVE_FOLDER_ID:-}" ]]; then
            printf '%s' "$SA_JSON" > "$GITHUB_WORKSPACE/sa.json"
            {
              echo "[gdrive]"
              echo "type = drive"
              echo "scope = drive"
              echo "root_folder_id = ${GDRIVE_FOLDER_ID}"
              echo "service_account_file = ${GITHUB_WORKSPACE}/sa.json"
            } > ~/.config/rclone/rclone.conf
          fi

      - name: Prepare local folder & download history
        run: |
          mkdir -p "$SAVE_DIR"
          # Si hay Drive configurado, baja histórico parquet:
          rclone copy gdrive: "$SAVE_DIR" --include "*_snapshot_*.parquet" -v --retries 3 || true

      - name: Run manual runner
        run: |
          args=()
          [[ -n "${{ github.event.inputs.category }}" ]] && args+=("--category" "${{ github.event.inputs.category }}")
          [[ -n "${{ github.event.inputs.start }}" ]] && args+=("--start" "${{ github.event.inputs.start }}")
          [[ -n "${{ github.event.inputs.page_size }}" ]] && args+=("--page-size" "${{ github.event.inputs.page_size }}")
          [[ -n "${{ github.event.inputs.page_step }}" ]] && args+=("--page-step" "${{ github.event.inputs.page_step }}")
          [[ -n "${{ github.event.inputs.max_pages }}" ]] && args+=("--max-pages" "${{ github.event.inputs.max_pages }}")
          echo "ARGS: ${args[@]-<none>}"
          python palacio_manual_runner.py "${args[@]}"

      - name: Upload outputs to Drive (optional)
        run: |
          rclone copy "$SAVE_DIR" gdrive: --include "*.xlsx" --include "*.parquet" -v --retries 3 --transfers 4 --checkers 8 || true

      - name: Upload artifacts (XLSX)
        uses: actions/upload-artifact@v4
        with:
          name: manual-xlsx
          path: ${{ env.SAVE_DIR }}/*.xlsx
          if-no-files-found: ignore
          retention-days: 3
