name: Palacio Scraper (A→B→C→D→E con histórico)

on:
  #schedule:
    # 3:00 AM (CDMX). Ajusta si lo necesitas.
    #- cron: "0 8 * * *"
  workflow_dispatch: {}

jobs:
  group_a:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    env:
      PYTHONUNBUFFERED: "1"
      SAVE_DIR: /tmp/palacio_out
      EMAIL_HOST:  ${{ secrets.EMAIL_HOST }}
      EMAIL_PORT:  ${{ secrets.EMAIL_PORT }}
      EMAIL_USER:  ${{ secrets.EMAIL_USER }}
      EMAIL_PASS:  ${{ secrets.EMAIL_PASS }}
      EMAIL_TO:    ${{ secrets.EMAIL_TO }}
      EMAIL_DEBUG: ${{ secrets.EMAIL_DEBUG }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Python 3.11
        uses: actions/setup-python@v5
        with: { python-version: "3.11" }
      - name: Instalar dependencias
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [[ -f requirements.txt ]]; then
            pip install -r requirements.txt
          else
            pip install requests pandas beautifulsoup4 xlsxwriter pyarrow fastparquet
          fi
      - name: Instalar rclone
        run: |
          sudo apt-get update
          sudo apt-get install -y rclone
      - name: Configurar rclone
        shell: bash
        env:
          RCLONE_CONFIG: ${{ secrets.RCLONE_CONFIG }}
          SA_JSON: ${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON }}
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        run: |
          set -euo pipefail
          mkdir -p ~/.config/rclone
          if [[ -n "${RCLONE_CONFIG:-}" ]]; then
            printf '%s\n' "$RCLONE_CONFIG" > ~/.config/rclone/rclone.conf
          else
            [[ -n "${SA_JSON:-}" && -n "${GDRIVE_FOLDER_ID:-}" ]] || { echo "Falta SA_JSON/GDRIVE_FOLDER_ID"; exit 1; }
            printf '%s' "$SA_JSON" > "$GITHUB_WORKSPACE/sa.json"
            {
              echo "[gdrive]"
              echo "type = drive"
              echo "scope = drive"
              echo "root_folder_id = ${GDRIVE_FOLDER_ID}"
              echo "service_account_file = ${GITHUB_WORKSPACE}/sa.json"
            } > ~/.config/rclone/rclone.conf
          fi
      - name: Preparar carpeta local y bajar histórico (.parquet)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$SAVE_DIR"
          rclone copy gdrive: "$SAVE_DIR" --include "*_snapshot_*.parquet" -v --retries 3 || true
          ls -lh "$SAVE_DIR" || true
      - name: Ejecutar grupo A (–all)
        run: |
          python palacio_group_a.py --all
      - name: Subir resultados (XLSX+PARQUET) a Drive
        run: |
          rclone copy "$SAVE_DIR" gdrive: --include "*.xlsx" --include "*.parquet" -v --retries 3 --transfers 4 --checkers 8

  group_b:
    runs-on: ubuntu-latest
    needs: group_a
    timeout-minutes: 360
    env:
      PYTHONUNBUFFERED: "1"
      SAVE_DIR: /tmp/palacio_out
      EMAIL_HOST:  ${{ secrets.EMAIL_HOST }}
      EMAIL_PORT:  ${{ secrets.EMAIL_PORT }}
      EMAIL_USER:  ${{ secrets.EMAIL_USER }}
      EMAIL_PASS:  ${{ secrets.EMAIL_PASS }}
      EMAIL_TO:    ${{ secrets.EMAIL_TO }}
      EMAIL_DEBUG: ${{ secrets.EMAIL_DEBUG }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Python 3.11
        uses: actions/setup-python@v5
        with: { python-version: "3.11" }
      - name: Instalar dependencias
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [[ -f requirements.txt ]]; then
            pip install -r requirements.txt
          else
            pip install requests pandas beautifulsoup4 xlsxwriter pyarrow fastparquet
          fi
      - name: Instalar rclone
        run: |
          sudo apt-get update
          sudo apt-get install -y rclone
      - name: Configurar rclone
        shell: bash
        env:
          RCLONE_CONFIG: ${{ secrets.RCLONE_CONFIG }}
          SA_JSON: ${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON }}
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        run: |
          set -euo pipefail
          mkdir -p ~/.config/rclone
          if [[ -n "${RCLONE_CONFIG:-}" ]]; then
            printf '%s\n' "$RCLONE_CONFIG" > ~/.config/rclone/rclone.conf
          else
            [[ -n "${SA_JSON:-}" && -n "${GDRIVE_FOLDER_ID:-}" ]] || { echo "Falta SA_JSON/GDRIVE_FOLDER_ID"; exit 1; }
            printf '%s' "$SA_JSON" > "$GITHUB_WORKSPACE/sa.json"
            {
              echo "[gdrive]"
              echo "type = drive"
              echo "scope = drive"
              echo "root_folder_id = ${GDRIVE_FOLDER_ID}"
              echo "service_account_file = ${GITHUB_WORKSPACE}/sa.json"
            } > ~/.config/rclone/rclone.conf
          fi
      - name: Preparar carpeta local y bajar histórico (.parquet)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$SAVE_DIR"
          rclone copy gdrive: "$SAVE_DIR" --include "*_snapshot_*.parquet" -v --retries 3 || true
          ls -lh "$SAVE_DIR" || true
      - name: Ejecutar grupo B (–all)
        run: |
          python palacio_group_b.py --all
      - name: Subir resultados (XLSX+PARQUET) a Drive
        run: |
          rclone copy "$SAVE_DIR" gdrive: --include "*.xlsx" --include "*.parquet" -v --retries 3 --transfers 4 --checkers 8

  group_c:
    runs-on: ubuntu-latest
    needs: group_b
    timeout-minutes: 360
    env:
      PYTHONUNBUFFERED: "1"
      SAVE_DIR: /tmp/palacio_out
      EMAIL_HOST:  ${{ secrets.EMAIL_HOST }}
      EMAIL_PORT:  ${{ secrets.EMAIL_PORT }}
      EMAIL_USER:  ${{ secrets.EMAIL_USER }}
      EMAIL_PASS:  ${{ secrets.EMAIL_PASS }}
      EMAIL_TO:    ${{ secrets.EMAIL_TO }}
      EMAIL_DEBUG: ${{ secrets.EMAIL_DEBUG }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Python 3.11
        uses: actions/setup-python@v5
        with: { python-version: "3.11" }
      - name: Instalar dependencias
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [[ -f requirements.txt ]]; then
            pip install -r requirements.txt
          else
            pip install requests pandas beautifulsoup4 xlsxwriter pyarrow fastparquet
          fi
      - name: Instalar rclone
        run: |
          sudo apt-get update
          sudo apt-get install -y rclone
      - name: Configurar rclone
        shell: bash
        env:
          RCLONE_CONFIG: ${{ secrets.RCLONE_CONFIG }}
          SA_JSON: ${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON }}
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        run: |
          set -euo pipefail
          mkdir -p ~/.config/rclone
          if [[ -n "${RCLONE_CONFIG:-}" ]]; then
            printf '%s\n' "$RCLONE_CONFIG" > ~/.config/rclone/rclone.conf
          else
            [[ -n "${SA_JSON:-}" && -n "${GDRIVE_FOLDER_ID:-}" ]] || { echo "Falta SA_JSON/GDRIVE_FOLDER_ID"; exit 1; }
            printf '%s' "$SA_JSON" > "$GITHUB_WORKSPACE/sa.json"
            {
              echo "[gdrive]"
              echo "type = drive"
              echo "scope = drive"
              echo "root_folder_id = ${GDRIVE_FOLDER_ID}"
              echo "service_account_file = ${GITHUB_WORKSPACE}/sa.json"
            } > ~/.config/rclone/rclone.conf
          fi
      - name: Preparar carpeta local y bajar histórico (.parquet)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$SAVE_DIR"
          rclone copy gdrive: "$SAVE_DIR" --include "*_snapshot_*.parquet" -v --retries 3 || true
          ls -lh "$SAVE_DIR" || true
      - name: Ejecutar grupo C (–all)
        run: |
          python palacio_group_c.py --all
      - name: Subir resultados (XLSX+PARQUET) a Drive
        run: |
          rclone copy "$SAVE_DIR" gdrive: --include "*.xlsx" --include "*.parquet" -v --retries 3 --transfers 4 --checkers 8

  group_d:
    runs-on: ubuntu-latest
    needs: group_c
    timeout-minutes: 360
    env:
      PYTHONUNBUFFERED: "1"
      SAVE_DIR: /tmp/palacio_out
      EMAIL_HOST:  ${{ secrets.EMAIL_HOST }}
      EMAIL_PORT:  ${{ secrets.EMAIL_PORT }}
      EMAIL_USER:  ${{ secrets.EMAIL_USER }}
      EMAIL_PASS:  ${{ secrets.EMAIL_PASS }}
      EMAIL_TO:    ${{ secrets.EMAIL_TO }}
      EMAIL_DEBUG: ${{ secrets.EMAIL_DEBUG }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Python 3.11
        uses: actions/setup-python@v5
        with: { python-version: "3.11" }
      - name: Instalar dependencias
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [[ -f requirements.txt ]]; then
            pip install -r requirements.txt
          else
            pip install requests pandas beautifulsoup4 xlsxwriter pyarrow fastparquet
          fi
      - name: Instalar rclone
        run: |
          sudo apt-get update
          sudo apt-get install -y rclone
      - name: Configurar rclone
        shell: bash
        env:
          RCLONE_CONFIG: ${{ secrets.RCLONE_CONFIG }}
          SA_JSON: ${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON }}
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        run: |
          set -euo pipefail
          mkdir -p ~/.config/rclone
          if [[ -n "${RCLONE_CONFIG:-}" ]]; then
            printf '%s\n' "$RCLONE_CONFIG" > ~/.config/rclone/rclone.conf
          else
            [[ -n "${SA_JSON:-}" && -n "${GDRIVE_FOLDER_ID:-}" ]] || { echo "Falta SA_JSON/GDRIVE_FOLDER_ID"; exit 1; }
            printf '%s' "$SA_JSON" > "$GITHUB_WORKSPACE/sa.json"
            {
              echo "[gdrive]"
              echo "type = drive"
              echo "scope = drive"
              echo "root_folder_id = ${GDRIVE_FOLDER_ID}"
              echo "service_account_file = ${GITHUB_WORKSPACE}/sa.json"
            } > ~/.config/rclone/rclone.conf
          fi
      - name: Preparar carpeta local y bajar histórico (.parquet)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$SAVE_DIR"
          rclone copy gdrive: "$SAVE_DIR" --include "*_snapshot_*.parquet" -v --retries 3 || true
          ls -lh "$SAVE_DIR" || true
      - name: Ejecutar grupo D (–all)
        run: |
          python palacio_group_d.py --all
      - name: Subir resultados (XLSX+PARQUET) a Drive
        run: |
          rclone copy "$SAVE_DIR" gdrive: --include "*.xlsx" --include "*.parquet" -v --retries 3 --transfers 4 --checkers 8

  group_e:
    runs-on: ubuntu-latest
    needs: group_d
    timeout-minutes: 360
    env:
      PYTHONUNBUFFERED: "1"
      SAVE_DIR: /tmp/palacio_out
      EMAIL_HOST:  ${{ secrets.EMAIL_HOST }}
      EMAIL_PORT:  ${{ secrets.EMAIL_PORT }}
      EMAIL_USER:  ${{ secrets.EMAIL_USER }}
      EMAIL_PASS:  ${{ secrets.EMAIL_PASS }}
      EMAIL_TO:    ${{ secrets.EMAIL_TO }}
      EMAIL_DEBUG: ${{ secrets.EMAIL_DEBUG }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Python 3.11
        uses: actions/setup-python@v5
        with: { python-version: "3.11" }
      - name: Instalar dependencias
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [[ -f requirements.txt ]]; then
            pip install -r requirements.txt
          else
            pip install requests pandas beautifulsoup4 xlsxwriter pyarrow fastparquet
          fi
      - name: Instalar rclone
        run: |
          sudo apt-get update
          sudo apt-get install -y rclone
      - name: Configurar rclone
        shell: bash
        env:
          RCLONE_CONFIG: ${{ secrets.RCLONE_CONFIG }}
          SA_JSON: ${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON }}
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        run: |
          set -euo pipefail
          mkdir -p ~/.config/rclone
          if [[ -n "${RCLONE_CONFIG:-}" ]]; then
            printf '%s\n' "$RCLONE_CONFIG" > ~/.config/rclone/rclone.conf
          else
            [[ -n "${SA_JSON:-}" && -n "${GDRIVE_FOLDER_ID:-}" ]] || { echo "Falta SA_JSON/GDRIVE_FOLDER_ID"; exit 1; }
            printf '%s' "$SA_JSON" > "$GITHUB_WORKSPACE/sa.json"
            {
              echo "[gdrive]"
              echo "type = drive"
              echo "scope = drive"
              echo "root_folder_id = ${GDRIVE_FOLDER_ID}"
              echo "service_account_file = ${GITHUB_WORKSPACE}/sa.json"
            } > ~/.config/rclone/rclone.conf
          fi
      - name: Preparar carpeta local y bajar histórico (.parquet)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$SAVE_DIR"
          rclone copy gdrive: "$SAVE_DIR" --include "*_snapshot_*.parquet" -v --retries 3 || true
          ls -lh "$SAVE_DIR" || true
      - name: Ejecutar grupo E (–all)
        run: |
          python palacio_group_e.py --all
      - name: Subir resultados (XLSX+PARQUET) a Drive
        run: |
          rclone copy "$SAVE_DIR" gdrive: --include "*.xlsx" --include "*.parquet" -v --retries 3 --transfers 4 --checkers 8
