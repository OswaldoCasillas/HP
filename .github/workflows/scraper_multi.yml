name: Palacio Scraper (A→B→C, RAM + Email + Drive)

on:
  schedule:
    # 3:00 AM America/Mexico_City ≈ 09:00Z (invierno) / 08:00Z (verano).
    - cron: "0 9 * * *"
  workflow_dispatch: {}

env:
  SAVE_DIR: /tmp/palacio_out
  EMAIL_HOST:  ${{ secrets.EMAIL_HOST }}
  EMAIL_PORT:  ${{ secrets.EMAIL_PORT }}
  EMAIL_USER:  ${{ secrets.EMAIL_USER }}
  EMAIL_PASS:  ${{ secrets.EMAIL_PASS }}
  EMAIL_TO:    ${{ secrets.EMAIL_TO }}
  EMAIL_DEBUG: ${{ secrets.EMAIL_DEBUG }}

jobs:
  scraper-a:
    name: Grupo A (mujer, hogar)
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas beautifulsoup4 xlsxwriter

      - name: Run A --all
        run: |
          mkdir -p "$SAVE_DIR"
          python palacio_scraper_A.py --all

      - name: Install rclone
        run: |
          sudo apt-get update
          sudo apt-get install -y rclone

      - name: Configure rclone
        shell: bash
        env:
          RCLONE_CONFIG_SECRET: ${{ secrets.RCLONE_CONFIG }}
          SA_JSON: ${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON }}
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        run: |
          set -euo pipefail
          mkdir -p ~/.config/rclone
          if [[ -n "${RCLONE_CONFIG_SECRET:-}" ]]; then
            printf '%s\n' "$RCLONE_CONFIG_SECRET" > ~/.config/rclone/rclone.conf
          else
            [[ -n "${SA_JSON:-}" && -n "${GDRIVE_FOLDER_ID:-}" ]] || { echo "Faltan GDRIVE_SERVICE_ACCOUNT_JSON o GDRIVE_FOLDER_ID"; exit 1; }
            printf '%s' "$SA_JSON" > "$GITHUB_WORKSPACE/sa.json"
            {
              echo "[gdrive]"
              echo "type = drive"
              echo "scope = drive"
              echo "root_folder_id = ${GDRIVE_FOLDER_ID}"
              echo "service_account_file = ${GITHUB_WORKSPACE}/sa.json"
            } > ~/.config/rclone/rclone.conf
          fi
          rclone version
          rclone listremotes

      - name: Upload XLSX to Drive
        run: |
          if compgen -G "$SAVE_DIR/*.xlsx" > /dev/null; then
            rclone copy "$SAVE_DIR" gdrive: --create-empty-src-dirs -v --retries 3 --transfers 4 --checkers 8
          else
            echo "No hay XLSX en $SAVE_DIR"
          fi

  scraper-b:
    name: Grupo B (hombre)
    runs-on: ubuntu-latest
    timeout-minutes: 360
    needs: scraper-a
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas beautifulsoup4 xlsxwriter

      - name: Run B --all
        run: |
          mkdir -p "$SAVE_DIR"
          python palacio_scraper_B.py --all

      - name: Install rclone
        run: |
          sudo apt-get update
          sudo apt-get install -y rclone

      - name: Configure rclone
        shell: bash
        env:
          RCLONE_CONFIG_SECRET: ${{ secrets.RCLONE_CONFIG }}
          SA_JSON: ${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON }}
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        run: |
          set -euo pipefail
          mkdir -p ~/.config/rclone
          if [[ -n "${RCLONE_CONFIG_SECRET:-}" ]]; then
            printf '%s\n' "$RCLONE_CONFIG_SECRET" > ~/.config/rclone/rclone.conf
          else
            [[ -n "${SA_JSON:-}" && -n "${GDRIVE_FOLDER_ID:-}" ]] || { echo "Faltan GDRIVE_SERVICE_ACCOUNT_JSON o GDRIVE_FOLDER_ID"; exit 1; }
            printf '%s' "$SA_JSON" > "$GITHUB_WORKSPACE/sa.json"
            {
              echo "[gdrive]"
              echo "type = drive"
              echo "scope = drive"
              echo "root_folder_id = ${GDRIVE_FOLDER_ID}"
              echo "service_account_file = ${GITHUB_WORKSPACE}/sa.json"
            } > ~/.config/rclone/rclone.conf
          fi
          rclone version
          rclone listremotes

      - name: Upload XLSX to Drive
        run: |
          if compgen -G "$SAVE_DIR/*.xlsx" > /dev/null; then
            rclone copy "$SAVE_DIR" gdrive: --create-empty-src-dirs -v --retries 3 --transfers 4 --checkers 8
          else
            echo "No hay XLSX en $SAVE_DIR"
          fi

  scraper-c:
    name: Grupo C (resto)
    runs-on: ubuntu-latest
    timeout-minutes: 360
    needs: scraper-b
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas beautifulsoup4 xlsxwriter

      - name: Run C --all
        run: |
          mkdir -p "$SAVE_DIR"
          python palacio_scraper_C.py --all

      - name: Install rclone
        run: |
          sudo apt-get update
          sudo apt-get install -y rclone

      - name: Configure rclone
        shell: bash
        env:
          RCLONE_CONFIG_SECRET: ${{ secrets.RCLONE_CONFIG }}
          SA_JSON: ${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON }}
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        run: |
          set -euo pipefail
          mkdir -p ~/.config/rclone
          if [[ -n "${RCLONE_CONFIG_SECRET:-}" ]]; then
            printf '%s\n' "$RCLONE_CONFIG_SECRET" > ~/.config/rclone/rclone.conf
          else
            [[ -n "${SA_JSON:-}" && -n "${GDRIVE_FOLDER_ID:-}" ]] || { echo "Faltan GDRIVE_SERVICE_ACCOUNT_JSON o GDRIVE_FOLDER_ID"; exit 1; }
            printf '%s' "$SA_JSON" > "$GITHUB_WORKSPACE/sa.json"
            {
              echo "[gdrive]"
              echo "type = drive"
              echo "scope = drive"
              echo "root_folder_id = ${GDRIVE_FOLDER_ID}"
              echo "service_account_file = ${GITHUB_WORKSPACE}/sa.json"
            } > ~/.config/rclone/rclone.conf
          fi
          rclone version
          rclone listremotes

      - name: Upload XLSX to Drive
        run: |
          if compgen -G "$SAVE_DIR/*.xlsx" > /dev/null; then
            rclone copy "$SAVE_DIR" gdrive: --create-empty-src-dirs -v --retries 3 --transfers 4 --checkers 8
          else
            echo "No hay XLSX en $SAVE_DIR"
          fi
