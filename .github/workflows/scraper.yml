name: Palacio Scraper (DISCO)

on:
  schedule:
    # GitHub usa UTC. 08:00 y 20:00 UTC ≈ 2:00 y 14:00 en CDMX (puede variar 1h con DST).
    - cron: "0 8,20 * * *"
  workflow_dispatch:
    inputs:
      run_all:
        description: "Ejecutar TODAS las categorías"
        type: boolean
        default: true
        required: true
      category:
        description: "Categoría única (si run_all = false). Ej: juguetes"
        type: string
        required: false
        default: ""
      start:
        description: "Offset inicial start="
        type: string
        required: false
        default: ""
      page_size:
        description: "Tamaño de página sz="
        type: string
        required: false
        default: ""
      page_step:
        description: "Salto de start"
        type: string
        required: false
        default: ""
      max_pages:
        description: "Máximo de páginas"
        type: string
        required: false
        default: ""
      highlight:
        description: "Umbral % para resaltar (XLSX)"
        type: string
        required: false
        default: "51"

permissions:
  contents: read

concurrency:
  group: palacio-scraper
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          # Si tienes requirements.txt, úsalo; si no, instala directas:
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install requests pandas beautifulsoup4 xlsxwriter pyarrow
          fi

      - name: Show runner time (UTC)
        run: date -u

      - name: Run scraper
        shell: bash
        run: |
          set -euo pipefail
          # Construir argumentos según si es schedule o manual
          ARGS=""
          # Inputs solo existen en workflow_dispatch; para schedule vienen vacíos
          RUN_ALL="${{ github.event_name == 'workflow_dispatch' && inputs.run_all || 'true' }}"
          CATEGORY="${{ github.event.inputs.category || '' }}"
          START="${{ github.event.inputs.start || '' }}"
          PAGE_SIZE="${{ github.event.inputs.page_size || '' }}"
          PAGE_STEP="${{ github.event.inputs.page_step || '' }}"
          MAX_PAGES="${{ github.event.inputs.max_pages || '' }}"
          HIGHLIGHT="${{ github.event.inputs.highlight || '' }}"

          if [[ "${RUN_ALL}" == "true" ]]; then
            ARGS+=" --all"
          else
            if [[ -z "${CATEGORY}" ]]; then
              echo "❌ Debes indicar 'category' cuando run_all=false."
              exit 1
            fi
            ARGS+=" -c ${CATEGORY}"
          fi

          [[ -n "${START}" ]] && ARGS+=" --start ${START}"
          [[ -n "${PAGE_SIZE}" ]] && ARGS+=" --page-size ${PAGE_SIZE}"
          [[ -n "${PAGE_STEP}" ]] && ARGS+=" --page-step ${PAGE_STEP}"
          [[ -n "${MAX_PAGES}" ]] && ARGS+=" --max-pages ${MAX_PAGES}"
          [[ -n "${HIGHLIGHT}" ]] && ARGS+=" --highlight ${HIGHLIGHT}"

          echo "▶ python palacio_category_snapshot.py ${ARGS}"
          python palacio_category_snapshot.py ${ARGS}

      - name: Upload outputs (out_palacio/)
        if: always()  # sube aunque falle, para poder revisar lo que alcanzó a generar
        uses: actions/upload-artifact@v4
        with:
          name: out_palacio-${{ github.run_id }}
          path: out_palacio/**
          if-no-files-found: warn
          retention-days: 10
