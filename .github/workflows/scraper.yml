name: Palacio Scraper (RAM-only email)

on:
  schedule:
    - cron: "0 9 * * *"   # 02:00 y 14:00 UTC de tu repo
  workflow_dispatch:
    inputs:
      run_all:
        description: "Correr TODAS las categorías?"
        type: boolean
        default: true
      category:
        description: "Si run_all=false, escribe la categoría exacta"
        required: false
      start:
        description: "start (opcional)"
        required: false
      page_size:
        description: "page-size (opcional)"
        required: false
      page_step:
        description: "page-step (opcional)"
        required: false
      max_pages:
        description: "max-pages (opcional)"
        required: false
      highlight:
        description: "highlight % (opcional)"
        required: false

concurrency:
  group: palacio-scraper-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # --- TODAS las categorías por matrix ---
  all:
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && inputs.run_all == 'true')
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        category:
          - ofertas
          - electronica
          - deportes
          - gourmet
          - casapalacio
          - nuevos-productos
          - mujer
          - productos-liquidacion
          - hombre
          - calzado
          - mujer-multimarcas
          - hombre-multimarcas
          - electronica-tablets
          - disenadores
          - hogar
          - juguetes
          - categorias
          - salas
          - tendencias
          - "más vendido"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Instalar deps
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas beautifulsoup4 xlsxwriter

      - name: Variables de correo
        run: |
          echo "EMAIL_HOST=${{ secrets.EMAIL_HOST }}" >> $GITHUB_ENV
          echo "EMAIL_PORT=${{ secrets.EMAIL_PORT }}" >> $GITHUB_ENV
          echo "EMAIL_USER=${{ secrets.EMAIL_USER }}" >> $GITHUB_ENV
          echo "EMAIL_PASS=${{ secrets.EMAIL_PASS }}" >> $GITHUB_ENV
          echo "EMAIL_TO=${{ secrets.EMAIL_TO }}"       >> $GITHUB_ENV

      - name: Ejecutar categoría (matrix)
        env:
          CAT: ${{ matrix.category }}
        run: |
          python palacio_category_snapshot_ramonly.py \
            -c "$CAT" \
            $([ -n "${{ inputs.start }}" ] && echo --start ${{ inputs.start }}) \
            $([ -n "${{ inputs.page_size }}" ] && echo --page-size ${{ inputs.page_size }}) \
            $([ -n "${{ inputs.page_step }}" ] && echo --page-step ${{ inputs.page_step }}) \
            $([ -n "${{ inputs.max_pages }}" ] && echo --max-pages ${{ inputs.max_pages }}) \
            $([ -n "${{ inputs.highlight }}" ] && echo --highlight ${{ inputs.highlight }})

  # --- UNA sola categoría manual ---
  one:
    if: github.event_name == 'workflow_dispatch' && inputs.run_all != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Instalar deps
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas beautifulsoup4 xlsxwriter
      - name: Variables de correo
        run: |
          echo "EMAIL_HOST=${{ secrets.EMAIL_HOST }}" >> $GITHUB_ENV
          echo "EMAIL_PORT=${{ secrets.EMAIL_PORT }}" >> $GITHUB_ENV
          echo "EMAIL_USER=${{ secrets.EMAIL_USER }}" >> $GITHUB_ENV
          echo "EMAIL_PASS=${{ secrets.EMAIL_PASS }}" >> $GITHUB_ENV
          echo "EMAIL_TO=${{ secrets.EMAIL_TO }}"       >> $GITHUB_ENV
      - name: Ejecutar una categoría
        run: |
          python palacio_category_snapshot_ramonly.py \
            -c "${{ inputs.category }}" \
            $([ -n "${{ inputs.start }}" ] && echo --start ${{ inputs.start }}) \
            $([ -n "${{ inputs.page_size }}" ] && echo --page-size ${{ inputs.page_size }}) \
            $([ -n "${{ inputs.page_step }}" ] && echo --page-step ${{ inputs.page_step }}) \
            $([ -n "${{ inputs.max_pages }}" ] && echo --max-pages ${{ inputs.max_pages }}) \
            $([ -n "${{ inputs.highlight }}" ] && echo --highlight ${{ inputs.highlight }})
