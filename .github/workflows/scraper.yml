name: Palacio Scraper (DISCO)

on:
  schedule:
    # GitHub usa UTC. 08:00 y 20:00 UTC â‰ˆ 02:00 y 14:00 CDMX (segÃºn DST).
    - cron: "0 8,20 * * *"
  workflow_dispatch:
    inputs:
      run_all:
        description: "Ejecutar TODAS las categorÃ­as"
        type: boolean
        default: true
        required: true
      category:
        description: "CategorÃ­a Ãºnica (si run_all = false). Ej: juguetes"
        type: string
        required: false
        default: ""
      start:
        description: "Offset inicial start="
        type: string
        required: false
        default: ""
      page_size:
        description: "TamaÃ±o de pÃ¡gina sz="
        type: string
        required: false
        default: ""
      page_step:
        description: "Salto de start"
        type: string
        required: false
        default: ""
      max_pages:
        description: "MÃ¡ximo de pÃ¡ginas"
        type: string
        required: false
        default: ""
      highlight:
        description: "Umbral % para resaltar (XLSX)"
        type: string
        required: false
        default: "51"

permissions:
  contents: read

concurrency:
  group: palacio-scraper
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install requests pandas beautifulsoup4 xlsxwriter pyarrow
          fi

      - name: Show runner time (UTC)
        run: date -u

      - name: Run scraper
        shell: bash
        run: |
          set -euo pipefail

          # Detecta si fue manual o por cron y toma inputs si existen
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            RUN_ALL="${{ github.event.inputs.run_all }}"
            CATEGORY="${{ github.event.inputs.category }}"
            START="${{ github.event.inputs.start }}"
            PAGE_SIZE='${{ github.event.inputs.page_size }}'
            PAGE_STEP='${{ github.event.inputs.page_step }}'
            MAX_PAGES='${{ github.event.inputs.max_pages }}'
            HIGHLIGHT='${{ github.event.inputs.highlight }}'
          else
            RUN_ALL="true"
            CATEGORY=""
            START=""
            PAGE_SIZE=""
            PAGE_STEP=""
            MAX_PAGES=""
            HIGHLIGHT="51"
          fi

          ARGS=""
          if [[ "${RUN_ALL}" == "true" || "${RUN_ALL}" == "True" ]]; then
            ARGS+=" --all"
          else
            if [[ -z "${CATEGORY}" ]]; then
              echo "âŒ Debes indicar 'category' cuando run_all=false."
              exit 1
            fi
            ARGS+=" -c ${CATEGORY}"
          fi

          [[ -n "${START}" ]] && ARGS+=" --start ${START}"
          [[ -n "${PAGE_SIZE}" ]] && ARGS+=" --page-size ${PAGE_SIZE}"
          [[ -n "${PAGE_STEP}" ]] && ARGS+=" --page-step ${PAGE_STEP}"
          [[ -n "${MAX_PAGES}" ]] && ARGS+=" --max-pages ${MAX_PAGES}"
          [[ -n "${HIGHLIGHT}" ]] && ARGS+=" --highlight ${HIGHLIGHT}"

          echo "â–¶ python palacio_category_snapshot.py ${ARGS}"
          python palacio_category_snapshot.py ${ARGS}

      - name: Upload outputs (out_palacio/)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: out_palacio-${{ github.run_id }}
          path: out_palacio/**
          if-no-files-found: warn
          retention-days: 10

      - name: Zip out_palacio
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          cd "${{ github.workspace }}"
          if [ -d "out_palacio" ]; then
            zip -r "out_palacio_${{ github.run_id }}.zip" out_palacio
            ls -lh "out_palacio_${{ github.run_id }}.zip"
          else
            echo "âš ï¸ No existe out_palacio/, no se genera ZIP."
            # Crear placeholder vacÃ­o para que el paso de email no truene
            echo "no outputs" > "out_palacio_${{ github.run_id }}.txt"
          fi

      - name: Email ZIP via Gmail
        if: always()
        env:
          EMAIL_HOST: smtp.gmail.com
          EMAIL_PORT: "587"
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO:   ${{ secrets.EMAIL_TO }}
        run: |
          python - << 'PY'
          import os, smtplib, ssl, mimetypes, pathlib
          from email.message import EmailMessage

          run_id = os.environ.get("GITHUB_RUN_ID")
          zip_path = f"out_palacio_{run_id}.zip"
          fallback_txt = f"out_palacio_{run_id}.txt"
          attach_path = zip_path if pathlib.Path(zip_path).exists() else fallback_txt

          user = os.environ.get("EMAIL_USER","")
          pwd  = os.environ.get("EMAIL_PASS","")
          to   = os.environ.get("EMAIL_TO","")

          if not user or not pwd or not to:
            print("âš ï¸ Falta EMAIL_USER/EMAIL_PASS/EMAIL_TO; no se envÃ­a correo.")
            raise SystemExit(0)

          msg = EmailMessage()
          msg["From"] = user
          msg["To"] = to
          msg["Subject"] = "[Scraper] out_palacio listo"
          msg.set_content("Adjunto ZIP (o placeholder) con la carpeta out_palacio generada en esta corrida.")

          ctype, _ = mimetypes.guess_type(attach_path)
          if not ctype: ctype = "application/octet-stream"
          maintype, subtype = ctype.split("/", 1)
          with open(attach_path, "rb") as f:
              msg.add_attachment(f.read(), maintype=maintype, subtype=subtype, filename=os.path.basename(attach_path))

          cx = smtplib.SMTP(os.environ["EMAIL_HOST"], int(os.environ["EMAIL_PORT"]))
          cx.ehlo(); cx.starttls(context=ssl.create_default_context()); cx.ehlo()
          cx.login(user, pwd)
          cx.send_message(msg)
          cx.quit()
          print("ðŸ“§ Enviado:", attach_path)
          PY


          
