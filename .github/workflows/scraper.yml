name: Palacio Scraper (RAM-only email)

on:
  schedule:
    # 03:00 y 15:00 Ciudad de México  →  09:00 y 21:00 UTC
    - cron: '0 9 * * *'
    - cron: '0 21 * * *'
  workflow_dispatch:
    inputs:
      run_all:
        description: "Run all categories?"
        type: boolean
        default: true
      category:
        description: "Single category (if run_all=false)"
        type: string
        default: ""
      start:
        description: "start offset"
        type: string
        default: ""
      page_size:
        description: "page size (sz)"
        type: string
        default: ""
      page_step:
        description: "page step"
        type: string
        default: ""
      max_pages:
        description: "max pages"
        type: string
        default: ""
      highlight:
        description: "highlight % for count"
        type: string
        default: "51"

jobs:
  run:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas requests beautifulsoup4 xlsxwriter urllib3==2.*

      # AUTO (cron): siempre --all, sin preguntar
      - name: Run scheduled (ALL categories)
        if: ${{ github.event_name == 'schedule' }}
        env:
          EMAIL_HOST: ${{ secrets.EMAIL_HOST }}
          EMAIL_PORT: ${{ secrets.EMAIL_PORT }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO:   ${{ secrets.EMAIL_TO }}
          EMAIL_DEBUG: "0"
        run: |
          python palacio_category_snapshot_ramonly.py --all --highlight 51

      # MANUAL (Actions → Run workflow): por defecto también --all
      - name: Run manual (with inputs)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        env:
          EMAIL_HOST: ${{ secrets.EMAIL_HOST }}
          EMAIL_PORT: ${{ secrets.EMAIL_PORT }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO:   ${{ secrets.EMAIL_TO }}
          EMAIL_DEBUG: "0"
        run: |
          if [ "${{ inputs.run_all }}" = "true" ]; then
            python palacio_category_snapshot_ramonly.py --all --highlight "${{ inputs.highlight }}"
          else
            EXTRA=""
            if [ -n "${{ inputs.start }}" ]; then EXTRA="$EXTRA --start ${{ inputs.start }}"; fi
            if [ -n "${{ inputs.page_size }}" ]; then EXTRA="$EXTRA --page-size ${{ inputs.page_size }}"; fi
            if [ -n "${{ inputs.page_step }}" ]; then EXTRA="$EXTRA --page-step ${{ inputs.page_step }}"; fi
            if [ -n "${{ inputs.max_pages }}" ]; then EXTRA="$EXTRA --max-pages ${{ inputs.max_pages }}"; fi
            if [ -n "${{ inputs.highlight }}" ]; then EXTRA="$EXTRA --highlight ${{ inputs.highlight }}"; fi
            python palacio_category_snapshot_ramonly.py -c "${{ inputs.category }}" $EXTRA
          fi
