name: Palacio Scraper (RAM + Email + Drive)

on:
 # schedule:
    # 3:00 AM America/Mexico_City (CDMX sin DST → 09:00Z todo el año)
   # - cron: "0 9 * * *"
  workflow_dispatch:
    inputs:
      run_all:
        description: "Correr TODAS las categorías"
        required: false
        default: "true"
        type: choice
        options: ["true","false"]
      category:
        description: "Si run_all=false, escribe una categoría (de tu script)"
        required: false
        default: ""
      start:
        description: "start (opcional)"
        required: false
        default: ""
      page_size:
        description: "page_size (opcional)"
        required: false
        default: ""
      page_step:
        description: "page_step (opcional)"
        required: false
        default: ""
      max_pages:
        description: "max_pages (opcional)"
        required: false
        default: ""
      highlight:
        description: "Umbral descuento (default del script)"
        required: false
        default: ""

jobs:
  run-scraper:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    env:
      EMAIL_HOST:  ${{ secrets.EMAIL_HOST }}
      EMAIL_PORT:  ${{ secrets.EMAIL_PORT }}
      EMAIL_USER:  ${{ secrets.EMAIL_USER }}
      EMAIL_PASS:  ${{ secrets.EMAIL_PASS }}
      EMAIL_TO:    ${{ secrets.EMAIL_TO }}
      EMAIL_DEBUG: ${{ secrets.EMAIL_DEBUG }}
      SAVE_DIR: /tmp/palacio_out

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas beautifulsoup4 xlsxwriter pyarrow

      - name: Crear carpeta de salida
        run: mkdir -p "$SAVE_DIR"

      # ───────── rclone: preparar Google Drive ─────────
      - name: Instalar rclone
        run: |
          sudo apt-get update
          sudo apt-get install -y rclone

      - name: Configurar rclone (usa RCLONE_CONFIG o Service Account JSON)
        shell: bash
        env:
          RCLONE_CONFIG_SECRET: ${{ secrets.RCLONE_CONFIG }}
          SA_JSON: ${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON }}
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        run: |
          set -euo pipefail
          mkdir -p ~/.config/rclone
          if [[ -n "${RCLONE_CONFIG_SECRET:-}" ]]; then
            echo "Usando rclone.conf del secret RCLONE_CONFIG"
            printf '%s\n' "$RCLONE_CONFIG_SECRET" > ~/.config/rclone/rclone.conf
          else
            echo "Construyendo rclone.conf con Service Account JSON"
            [[ -n "${SA_JSON:-}" && -n "${GDRIVE_FOLDER_ID:-}" ]] || { echo "Faltan GDRIVE_SERVICE_ACCOUNT_JSON o GDRIVE_FOLDER_ID"; exit 1; }
            printf '%s' "$SA_JSON" > "$GITHUB_WORKSPACE/sa.json"
            {
              echo "[gdrive]"
              echo "type = drive"
              echo "scope = drive"
              echo "root_folder_id = ${GDRIVE_FOLDER_ID}"
              echo "service_account_file = ${GITHUB_WORKSPACE}/sa.json"
            } > ~/.config/rclone/rclone.conf
          fi
          rclone version
          rclone listremotes

      - name: Bajar histórico (*.parquet) desde Drive a $SAVE_DIR
        run: |
          mkdir -p "$SAVE_DIR"
          # Trae sólo los parquet para que el script pueda comparar
          rclone copy gdrive: "$SAVE_DIR" --include "*.parquet" -v --fast-list || true
          ls -lh "$SAVE_DIR" || true

      # ───────── Ejecutar scraper (usa históricos descargados) ─────────
      - name: Ejecutar scraper
        shell: bash
        run: |
          set -euo pipefail
          args=()
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ "${{ inputs.run_all }}" == "true" ]]; then
              args+=(--all)
            else
              [[ -n "${{ inputs.category }}" ]] || { echo "run_all=false pero sin 'category'"; exit 1; }
              args+=(-c "${{ inputs.category }}")
            fi
            [[ -n "${{ inputs.start }}"     ]] && args+=(--start "${{ inputs.start }}")
            [[ -n "${{ inputs.page_size }}" ]] && args+=(--page-size "${{ inputs.page_size }}")
            [[ -n "${{ inputs.page_step }}" ]] && args+=(--page-step "${{ inputs.page_step }}")
            [[ -n "${{ inputs.max_pages }}" ]] && args+=(--max-pages "${{ inputs.max_pages }}")
            [[ -n "${{ inputs.highlight }}" ]] && args+=(--highlight "${{ inputs.highlight }}")
          else
            args+=(--all)
          fi
          echo "Args: ${args[@]-<none>}"
          python palacio_category_snapshot_ramonly.py "${args[@]}"

      - name: Subir XLSX y PARQUET a Drive
        run: |
          rclone copy "$SAVE_DIR" gdrive: --include "*.xlsx" --include "*.parquet" \
            --create-empty-src-dirs -v --retries 3 --transfers 4 --checkers 8
          echo "Contenido en $SAVE_DIR:"
          ls -lh "$SAVE_DIR" || true
