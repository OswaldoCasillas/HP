name: Palacio Scraper (RAM-only email)

on:
  schedule:
    # 2:00 y 14:00 hora de CDMX (UTC−6) = 08:00 y 20:00 UTC
    - cron: '0 8,20 * * *'
  workflow_dispatch:
    inputs:
      run_all:
        description: 'Run ALL categories? (true/false). Si true, ignora "category".'
        required: true
        default: 'true'
      category:
        description: 'Categoría única (si run_all=false). Debe existir en CATEGORIES del script.'
        required: false
        default: ''
      start:
        description: 'start (int)'
        required: false
        default: '0'
      page_size:
        description: 'sz'
        required: false
        default: ''
      page_step:
        description: 'step'
        required: false
        default: ''
      max_pages:
        description: 'max pages'
        required: false
        default: ''
      highlight:
        description: 'highlight %'
        required: false
        default: '51'

jobs:
  run-scraper:
    runs-on: ubuntu-latest
    # GitHub Actions tiene tope de 360 min (6h)
    timeout-minutes: 360

    steps:
      - name: Checkout repo
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt

      - name: Run scraper
        env:
          # Pasamos los secretos (si no existen, el script usa defaults seguros)
          EMAIL_HOST: ${{ secrets.EMAIL_HOST }}
          EMAIL_PORT: ${{ secrets.EMAIL_PORT }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO:   ${{ secrets.EMAIL_TO }}

          # Inputs del dispatch (cuando se corre manualmente desde Actions)
          RUN_ALL:   ${{ github.event.inputs.run_all }}
          CATEGORY:  ${{ github.event.inputs.category }}
          START:     ${{ github.event.inputs.start }}
          PAGE_SIZE: ${{ github.event.inputs.page_size }}
          PAGE_STEP: ${{ github.event.inputs.page_step }}
          MAX_PAGES: ${{ github.event.inputs.max_pages }}
          HIGHLIGHT: ${{ github.event.inputs.highlight }}
        shell: bash
        run: |
          set -euo pipefail
          # Defaults cuando no viene por workflow_dispatch:
          RUN_ALL="${RUN_ALL:-true}"
          CATEGORY="${CATEGORY:-}"
          START="${START:-0}"
          PAGE_SIZE="${PAGE_SIZE:-}"
          PAGE_STEP="${PAGE_STEP:-}"
          MAX_PAGES="${MAX_PAGES:-}"
          HIGHLIGHT="${HIGHLIGHT:-51}"

          ARGS=()
          if [[ "${RUN_ALL,,}" == "true" ]]; then
            ARGS+=(--all)
          else
            if [[ -z "${CATEGORY}" ]]; then
              echo "ERROR: run_all=false pero 'category' vacío"; exit 1
            fi
            ARGS+=(-c "${CATEGORY}")
          fi

          # Parámetros opcionales
          [[ -n "${START}"     ]] && ARGS+=(--start "${START}")
          [[ -n "${PAGE_SIZE}" ]] && ARGS+=(--page-size "${PAGE_SIZE}")
          [[ -n "${PAGE_STEP}" ]] && ARGS+=(--page-step "${PAGE_STEP}")
          [[ -n "${MAX_PAGES}" ]] && ARGS+=(--max-pages "${MAX_PAGES}")
          [[ -n "${HIGHLIGHT}" ]] && ARGS+=(--highlight "${HIGHLIGHT}")

          echo "python palacio_category_snapshot_ramonly.py ${ARGS[*]}"
          python palacio_category_snapshot_ramonly.py "${ARGS[@]}"

